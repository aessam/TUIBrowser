// TUIRender - PNG Renderer
//
// Renders a Canvas to a PNG image file for debugging and visualization.

import Foundation
import TUICore
import TUITerminal

#if canImport(CoreGraphics) && canImport(ImageIO)
import CoreGraphics
import ImageIO
import UniformTypeIdentifiers

/// Renders a Canvas to a PNG image
public struct PNGRenderer: Sendable {
    /// Cell dimensions in pixels
    public let cellWidth: Int
    public let cellHeight: Int

    /// Font settings (for future use with actual font rendering)
    public let fontSize: Int

    public init(cellWidth: Int = 10, cellHeight: Int = 20, fontSize: Int = 16) {
        self.cellWidth = cellWidth
        self.cellHeight = cellHeight
        self.fontSize = fontSize
    }

    /// Render a Canvas to a PNG file
    /// - Parameters:
    ///   - canvas: The canvas to render
    ///   - path: Output file path
    /// - Returns: true if successful
    public func render(_ canvas: Canvas, to path: String) -> Bool {
        let imageWidth = canvas.width * cellWidth
        let imageHeight = canvas.height * cellHeight

        // Create pixel buffer (RGBA)
        var pixels = [UInt8](repeating: 0, count: imageWidth * imageHeight * 4)

        // Render each cell
        for y in 0..<canvas.height {
            for x in 0..<canvas.width {
                let cell = canvas[x, y]
                renderCell(cell, at: (x, y), into: &pixels, imageWidth: imageWidth)
            }
        }

        // Create CGImage
        guard let cgImage = createCGImage(from: pixels, width: imageWidth, height: imageHeight) else {
            return false
        }

        // Write to file
        return writePNG(cgImage, to: path)
    }

    /// Render a single cell into the pixel buffer
    private func renderCell(_ cell: Cell, at position: (x: Int, y: Int), into pixels: inout [UInt8], imageWidth: Int) {
        let startX = position.x * cellWidth
        let startY = position.y * cellHeight

        // Get colors
        let fg = cell.style.foreground ?? Color.white
        let bg = cell.style.background ?? Color.black

        // Fill background
        for dy in 0..<cellHeight {
            for dx in 0..<cellWidth {
                let pixelX = startX + dx
                let pixelY = startY + dy
                let offset = (pixelY * imageWidth + pixelX) * 4

                pixels[offset] = bg.r
                pixels[offset + 1] = bg.g
                pixels[offset + 2] = bg.b
                pixels[offset + 3] = 255
            }
        }

        // Render character as simple bitmap
        renderCharacter(cell.character, foreground: fg, bold: cell.style.bold,
                       startX: startX, startY: startY, into: &pixels, imageWidth: imageWidth)
    }

    /// Render a character using simple bitmap font
    private func renderCharacter(_ char: Character, foreground fg: Color, bold: Bool,
                                  startX: Int, startY: Int, into pixels: inout [UInt8], imageWidth: Int) {
        // Skip spaces
        guard char != " " else { return }

        // Get bitmap for character
        let bitmap = getCharacterBitmap(char)

        // Scale and render bitmap
        let scaleX = Double(cellWidth) / 8.0
        let scaleY = Double(cellHeight) / 16.0

        for dy in 0..<cellHeight {
            for dx in 0..<cellWidth {
                let srcX = Int(Double(dx) / scaleX)
                let srcY = Int(Double(dy) / scaleY)

                if srcY < bitmap.count && srcX < 8 {
                    let row = bitmap[srcY]
                    let bit = (row >> (7 - srcX)) & 1

                    if bit == 1 {
                        let pixelX = startX + dx
                        let pixelY = startY + dy
                        let offset = (pixelY * imageWidth + pixelX) * 4

                        pixels[offset] = fg.r
                        pixels[offset + 1] = fg.g
                        pixels[offset + 2] = fg.b
                        pixels[offset + 3] = 255

                        // Bold: also set adjacent pixel
                        if bold && dx + 1 < cellWidth {
                            let boldOffset = offset + 4
                            pixels[boldOffset] = fg.r
                            pixels[boldOffset + 1] = fg.g
                            pixels[boldOffset + 2] = fg.b
                            pixels[boldOffset + 3] = 255
                        }
                    }
                }
            }
        }
    }

    /// Get a simple 8x16 bitmap for a character
    private func getCharacterBitmap(_ char: Character) -> [UInt8] {
        // Basic ASCII character bitmaps (8 wide, 16 tall)
        // This is a minimal set - extend as needed
        switch char {
        case "A": return [0x00,0x00,0x18,0x3C,0x66,0x66,0x7E,0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00,0x00]
        case "B": return [0x00,0x00,0x7C,0x66,0x66,0x7C,0x66,0x66,0x66,0x7C,0x00,0x00,0x00,0x00,0x00,0x00]
        case "C": return [0x00,0x00,0x3C,0x66,0x60,0x60,0x60,0x60,0x66,0x3C,0x00,0x00,0x00,0x00,0x00,0x00]
        case "D": return [0x00,0x00,0x78,0x6C,0x66,0x66,0x66,0x66,0x6C,0x78,0x00,0x00,0x00,0x00,0x00,0x00]
        case "E": return [0x00,0x00,0x7E,0x60,0x60,0x7C,0x60,0x60,0x60,0x7E,0x00,0x00,0x00,0x00,0x00,0x00]
        case "F": return [0x00,0x00,0x7E,0x60,0x60,0x7C,0x60,0x60,0x60,0x60,0x00,0x00,0x00,0x00,0x00,0x00]
        case "G": return [0x00,0x00,0x3C,0x66,0x60,0x60,0x6E,0x66,0x66,0x3E,0x00,0x00,0x00,0x00,0x00,0x00]
        case "H": return [0x00,0x00,0x66,0x66,0x66,0x7E,0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00,0x00,0x00]
        case "I": return [0x00,0x00,0x3C,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00,0x00,0x00]
        case "J": return [0x00,0x00,0x1E,0x0C,0x0C,0x0C,0x0C,0x6C,0x6C,0x38,0x00,0x00,0x00,0x00,0x00,0x00]
        case "K": return [0x00,0x00,0x66,0x6C,0x78,0x70,0x78,0x6C,0x66,0x66,0x00,0x00,0x00,0x00,0x00,0x00]
        case "L": return [0x00,0x00,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x7E,0x00,0x00,0x00,0x00,0x00,0x00]
        case "M": return [0x00,0x00,0x63,0x77,0x7F,0x6B,0x63,0x63,0x63,0x63,0x00,0x00,0x00,0x00,0x00,0x00]
        case "N": return [0x00,0x00,0x66,0x76,0x7E,0x7E,0x6E,0x66,0x66,0x66,0x00,0x00,0x00,0x00,0x00,0x00]
        case "O": return [0x00,0x00,0x3C,0x66,0x66,0x66,0x66,0x66,0x66,0x3C,0x00,0x00,0x00,0x00,0x00,0x00]
        case "P": return [0x00,0x00,0x7C,0x66,0x66,0x7C,0x60,0x60,0x60,0x60,0x00,0x00,0x00,0x00,0x00,0x00]
        case "Q": return [0x00,0x00,0x3C,0x66,0x66,0x66,0x66,0x6E,0x3C,0x0E,0x00,0x00,0x00,0x00,0x00,0x00]
        case "R": return [0x00,0x00,0x7C,0x66,0x66,0x7C,0x78,0x6C,0x66,0x66,0x00,0x00,0x00,0x00,0x00,0x00]
        case "S": return [0x00,0x00,0x3C,0x66,0x60,0x3C,0x06,0x06,0x66,0x3C,0x00,0x00,0x00,0x00,0x00,0x00]
        case "T": return [0x00,0x00,0x7E,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00]
        case "U": return [0x00,0x00,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x3C,0x00,0x00,0x00,0x00,0x00,0x00]
        case "V": return [0x00,0x00,0x66,0x66,0x66,0x66,0x66,0x3C,0x3C,0x18,0x00,0x00,0x00,0x00,0x00,0x00]
        case "W": return [0x00,0x00,0x63,0x63,0x63,0x6B,0x7F,0x77,0x63,0x63,0x00,0x00,0x00,0x00,0x00,0x00]
        case "X": return [0x00,0x00,0x66,0x66,0x3C,0x18,0x3C,0x66,0x66,0x66,0x00,0x00,0x00,0x00,0x00,0x00]
        case "Y": return [0x00,0x00,0x66,0x66,0x66,0x3C,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00]
        case "Z": return [0x00,0x00,0x7E,0x06,0x0C,0x18,0x30,0x60,0x60,0x7E,0x00,0x00,0x00,0x00,0x00,0x00]
        case "a": return [0x00,0x00,0x00,0x00,0x3C,0x06,0x3E,0x66,0x66,0x3E,0x00,0x00,0x00,0x00,0x00,0x00]
        case "b": return [0x00,0x00,0x60,0x60,0x7C,0x66,0x66,0x66,0x66,0x7C,0x00,0x00,0x00,0x00,0x00,0x00]
        case "c": return [0x00,0x00,0x00,0x00,0x3C,0x66,0x60,0x60,0x66,0x3C,0x00,0x00,0x00,0x00,0x00,0x00]
        case "d": return [0x00,0x00,0x06,0x06,0x3E,0x66,0x66,0x66,0x66,0x3E,0x00,0x00,0x00,0x00,0x00,0x00]
        case "e": return [0x00,0x00,0x00,0x00,0x3C,0x66,0x7E,0x60,0x66,0x3C,0x00,0x00,0x00,0x00,0x00,0x00]
        case "f": return [0x00,0x00,0x1C,0x36,0x30,0x7C,0x30,0x30,0x30,0x30,0x00,0x00,0x00,0x00,0x00,0x00]
        case "g": return [0x00,0x00,0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x66,0x3C,0x00,0x00,0x00,0x00,0x00]
        case "h": return [0x00,0x00,0x60,0x60,0x7C,0x66,0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00,0x00,0x00]
        case "i": return [0x00,0x00,0x18,0x00,0x38,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00,0x00,0x00]
        case "j": return [0x00,0x00,0x0C,0x00,0x1C,0x0C,0x0C,0x0C,0x6C,0x6C,0x38,0x00,0x00,0x00,0x00,0x00]
        case "k": return [0x00,0x00,0x60,0x60,0x66,0x6C,0x78,0x6C,0x66,0x66,0x00,0x00,0x00,0x00,0x00,0x00]
        case "l": return [0x00,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00,0x00,0x00]
        case "m": return [0x00,0x00,0x00,0x00,0x76,0x7F,0x6B,0x6B,0x63,0x63,0x00,0x00,0x00,0x00,0x00,0x00]
        case "n": return [0x00,0x00,0x00,0x00,0x7C,0x66,0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00,0x00,0x00]
        case "o": return [0x00,0x00,0x00,0x00,0x3C,0x66,0x66,0x66,0x66,0x3C,0x00,0x00,0x00,0x00,0x00,0x00]
        case "p": return [0x00,0x00,0x00,0x00,0x7C,0x66,0x66,0x7C,0x60,0x60,0x60,0x00,0x00,0x00,0x00,0x00]
        case "q": return [0x00,0x00,0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x06,0x06,0x00,0x00,0x00,0x00,0x00]
        case "r": return [0x00,0x00,0x00,0x00,0x7C,0x66,0x60,0x60,0x60,0x60,0x00,0x00,0x00,0x00,0x00,0x00]
        case "s": return [0x00,0x00,0x00,0x00,0x3E,0x60,0x3C,0x06,0x06,0x7C,0x00,0x00,0x00,0x00,0x00,0x00]
        case "t": return [0x00,0x00,0x30,0x30,0x7C,0x30,0x30,0x30,0x36,0x1C,0x00,0x00,0x00,0x00,0x00,0x00]
        case "u": return [0x00,0x00,0x00,0x00,0x66,0x66,0x66,0x66,0x66,0x3E,0x00,0x00,0x00,0x00,0x00,0x00]
        case "v": return [0x00,0x00,0x00,0x00,0x66,0x66,0x66,0x3C,0x3C,0x18,0x00,0x00,0x00,0x00,0x00,0x00]
        case "w": return [0x00,0x00,0x00,0x00,0x63,0x63,0x6B,0x6B,0x7F,0x36,0x00,0x00,0x00,0x00,0x00,0x00]
        case "x": return [0x00,0x00,0x00,0x00,0x66,0x3C,0x18,0x3C,0x66,0x66,0x00,0x00,0x00,0x00,0x00,0x00]
        case "y": return [0x00,0x00,0x00,0x00,0x66,0x66,0x66,0x3E,0x06,0x66,0x3C,0x00,0x00,0x00,0x00,0x00]
        case "z": return [0x00,0x00,0x00,0x00,0x7E,0x0C,0x18,0x30,0x60,0x7E,0x00,0x00,0x00,0x00,0x00,0x00]
        case "0": return [0x00,0x00,0x3C,0x66,0x6E,0x76,0x66,0x66,0x66,0x3C,0x00,0x00,0x00,0x00,0x00,0x00]
        case "1": return [0x00,0x00,0x18,0x38,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00,0x00,0x00]
        case "2": return [0x00,0x00,0x3C,0x66,0x06,0x0C,0x18,0x30,0x60,0x7E,0x00,0x00,0x00,0x00,0x00,0x00]
        case "3": return [0x00,0x00,0x3C,0x66,0x06,0x1C,0x06,0x06,0x66,0x3C,0x00,0x00,0x00,0x00,0x00,0x00]
        case "4": return [0x00,0x00,0x0C,0x1C,0x3C,0x6C,0x7E,0x0C,0x0C,0x0C,0x00,0x00,0x00,0x00,0x00,0x00]
        case "5": return [0x00,0x00,0x7E,0x60,0x7C,0x06,0x06,0x06,0x66,0x3C,0x00,0x00,0x00,0x00,0x00,0x00]
        case "6": return [0x00,0x00,0x1C,0x30,0x60,0x7C,0x66,0x66,0x66,0x3C,0x00,0x00,0x00,0x00,0x00,0x00]
        case "7": return [0x00,0x00,0x7E,0x06,0x0C,0x18,0x30,0x30,0x30,0x30,0x00,0x00,0x00,0x00,0x00,0x00]
        case "8": return [0x00,0x00,0x3C,0x66,0x66,0x3C,0x66,0x66,0x66,0x3C,0x00,0x00,0x00,0x00,0x00,0x00]
        case "9": return [0x00,0x00,0x3C,0x66,0x66,0x3E,0x06,0x0C,0x18,0x30,0x00,0x00,0x00,0x00,0x00,0x00]
        case ".": return [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00]
        case ",": return [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x30,0x00,0x00,0x00,0x00,0x00]
        case ":": return [0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00]
        case ";": return [0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x30,0x00,0x00,0x00,0x00,0x00]
        case "!": return [0x00,0x00,0x18,0x18,0x18,0x18,0x18,0x18,0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00]
        case "?": return [0x00,0x00,0x3C,0x66,0x06,0x0C,0x18,0x18,0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00]
        case "-": return [0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]
        case "_": return [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00]
        case "/": return [0x00,0x00,0x06,0x06,0x0C,0x0C,0x18,0x18,0x30,0x30,0x60,0x60,0x00,0x00,0x00,0x00]
        case "|": return [0x00,0x00,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00]
        case "(": return [0x00,0x00,0x0C,0x18,0x30,0x30,0x30,0x30,0x18,0x0C,0x00,0x00,0x00,0x00,0x00,0x00]
        case ")": return [0x00,0x00,0x30,0x18,0x0C,0x0C,0x0C,0x0C,0x18,0x30,0x00,0x00,0x00,0x00,0x00,0x00]
        case "[": return [0x00,0x00,0x3C,0x30,0x30,0x30,0x30,0x30,0x30,0x3C,0x00,0x00,0x00,0x00,0x00,0x00]
        case "]": return [0x00,0x00,0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00,0x00,0x00,0x00,0x00,0x00]
        case "<": return [0x00,0x00,0x00,0x06,0x0C,0x18,0x30,0x18,0x0C,0x06,0x00,0x00,0x00,0x00,0x00,0x00]
        case ">": return [0x00,0x00,0x00,0x60,0x30,0x18,0x0C,0x18,0x30,0x60,0x00,0x00,0x00,0x00,0x00,0x00]
        case "=": return [0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]
        case "+": return [0x00,0x00,0x00,0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00]
        case "*": return [0x00,0x00,0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]
        case "@": return [0x00,0x00,0x3C,0x66,0x6E,0x6A,0x6E,0x60,0x60,0x3E,0x00,0x00,0x00,0x00,0x00,0x00]
        case "#": return [0x00,0x00,0x36,0x36,0x7F,0x36,0x36,0x7F,0x36,0x36,0x00,0x00,0x00,0x00,0x00,0x00]
        case "$": return [0x00,0x18,0x3E,0x60,0x3C,0x06,0x7C,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00]
        case "%": return [0x00,0x00,0x62,0x66,0x0C,0x18,0x30,0x66,0x46,0x00,0x00,0x00,0x00,0x00,0x00,0x00]
        case "&": return [0x00,0x00,0x38,0x6C,0x38,0x70,0x6B,0x66,0x3B,0x00,0x00,0x00,0x00,0x00,0x00,0x00]
        case "'": return [0x00,0x00,0x18,0x18,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]
        case "\"": return [0x00,0x00,0x66,0x66,0x66,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]
        case "Â©": return [0x00,0x00,0x3C,0x42,0x99,0xA1,0xA1,0x99,0x42,0x3C,0x00,0x00,0x00,0x00,0x00,0x00]
        default:
            // Generic filled box for unknown characters
            return [0x00,0x00,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x00,0x00,0x00,0x00,0x00,0x00]
        }
    }

    /// Create a CGImage from pixel data
    private func createCGImage(from pixels: [UInt8], width: Int, height: Int) -> CGImage? {
        let bitsPerComponent = 8
        let bitsPerPixel = 32
        let bytesPerRow = width * 4

        let colorSpace = CGColorSpaceCreateDeviceRGB()
        let bitmapInfo = CGBitmapInfo(rawValue: CGImageAlphaInfo.premultipliedLast.rawValue)

        guard let provider = CGDataProvider(data: Data(pixels) as CFData) else {
            return nil
        }

        return CGImage(
            width: width,
            height: height,
            bitsPerComponent: bitsPerComponent,
            bitsPerPixel: bitsPerPixel,
            bytesPerRow: bytesPerRow,
            space: colorSpace,
            bitmapInfo: bitmapInfo,
            provider: provider,
            decode: nil,
            shouldInterpolate: false,
            intent: .defaultIntent
        )
    }

    /// Write a CGImage to a PNG file
    private func writePNG(_ image: CGImage, to path: String) -> Bool {
        let url = URL(fileURLWithPath: path)

        guard let destination = CGImageDestinationCreateWithURL(
            url as CFURL,
            UTType.png.identifier as CFString,
            1,
            nil
        ) else {
            return false
        }

        CGImageDestinationAddImage(destination, image, nil)
        return CGImageDestinationFinalize(destination)
    }
}

#else
// Fallback for non-Apple platforms
public struct PNGRenderer: Sendable {
    public init(cellWidth: Int = 10, cellHeight: Int = 20, fontSize: Int = 16) {}

    public func render(_ canvas: Canvas, to path: String) -> Bool {
        print("PNG rendering is only available on macOS")
        return false
    }
}
#endif
